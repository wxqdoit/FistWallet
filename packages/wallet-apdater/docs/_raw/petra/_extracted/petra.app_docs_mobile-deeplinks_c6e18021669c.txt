[LI] Petra WebIntroduction
[LI] Frequently Asked Questions
[LI] Developer's GuideQuick Start
[LI] Error Codes
[LI] Telegram
[LI] Sign In with Aptos
[LI] Petra VaultIntroduction
[LI] GuidesCreate a Vault
[LI] Transaction Management
[LI] Publish a Contract
[LI] Backup your Vaults
[LI] Earn
[LI] DevelopersAccounts Types
[LI] Connecting to Petra Wallet
[LI] Deep Linking to Mobile App
[LI] Event Listening
[LI] Identifying Errors
[LI] Sending a Transaction
[LI] Signing Messages
[LI] Using Petra
[LI] Frequently Asked Questions
[P] On This Page
[LI] Supported Deep Links
[LI] 1. Open a dApp
[LI] 2. Send Coins
[LI] Mobile 2 Mobile Communication
[LI] Prerequisites
[LI] Petra Deep Link Structure
[LI] Constants
[LI] Generate Key Pair
[LI] Connect
[LI] Handling Petra Response
[LI] Sign and Submit Transaction
[LI] Sign Message
[LI] Example
[LI] Disconnect
[LI] Example
[H1] Deep Linking to Mobile App
[P] A deep link is a specialized URL that directs users to a specific location or content within a mobile app. It enables smooth navigation, allowing users to move seamlessly from a website, email, or another app directly to a particular section or page within a mobile app.
[H2] Supported Deep Links
[P] Petra mobile app supports the following deep links:
[H3] 1. Open a dApp
[P] Redirect users to a specific dApp within the Explore tab of the Petra app. If your dApp is a mobile app, see the Mobile 2 Mobile communication section.
[P] Format:
[CODE] https://petra.app/explore?link=<dapp_url>
[CODE] Ensure the <dapp_url>
[P] Example:
[CODE] https://petra.app/explore?link=https://app.ariesmarkets.xyz
[P] In this example, users are redirected to the Aries Markets dApp (https://app.ariesmarkets.xyz (opens in a new tab)) within the Explore tab of the Petra app.
[H3] 2. Send Coins
[P] Redirect users to the Petra app to select the coin and amount to send to the specified wallet address.
[P] Format:
[CODE] https://petra.app/receive?address=<wallet_address>
[CODE] Ensure the <wallet_address>
[P] Example:
[CODE] https://petra.app/receive?address=0x0000000000000000000000000000000000000000000000000000000000000001
[CODE] In this example, users are redirected to the Petra app to select the coin and amount to send to the wallet address 0x0000000000000000000000000000000000000000000000000000000000000001
[H2] Mobile 2 Mobile Communication
[P] If your dApp is a mobile app and you want to sign transactions through Petra wallet, you can use deep links to establish a secure connection between your dApp and the Petra wallet. This provides a comprehensive guide for implementing deep link connections between your mobile decentralized application (dApp) and the Petra wallet. The goal is to enable secure interactions such as connecting, disconnecting, and signing transactions with the Petra wallet. While the provided example is in React Native, the concepts and steps are applicable to any language.
[H3] Prerequisites
[LI] Petra Wallet: Make sure you have the Petra mobile wallet (opens in a new tab) installed and configured on your device.
[LI] Deep Links: Ensure you are familiar with how deep linking works on your target platform and make sure it's already working on your dApp. Here's a comprehensive guide for React Native deep linking setup (opens in a new tab).
[LI] Cryptography: Basic understanding of public-private key pairs, encryption, and decryption.
[H3] Petra Deep Link Structure
[P] Petra utilizes a specific deep link format to handle communication between your dApp and the wallet. Here's the breakdown:
[CODE] Base URL:

petra://api/v1
[CODE] Endpoints:

/connect
[CODE] /disconnect
[CODE] /signAndSubmit
[CODE] Data Parameter:

Petra expects data to be passed as a base64 encoded JSON string attached to the deep link using the data
[H3] Constants
[P] The following constants are used throughout the implementation and mentioned in the example code:
[CODE] Deep Link Base URLs: The base URLs for initiating connections and transactions.

PETRA_LINK_BASE
[CODE] petra://api/v1
[CODE] DAPP_LINK_BASE
[CODE] <your-dapp-domain>:///api/<version>
[CODE] App Info: Information about your dApp, serving as an identifier for Petra.

APP_INFO
[CODE] domain
[CODE] name
[P] Format:
[CODE] const PETRA_LINK_BASE = 'petra://api/v1';
const DAPP_LINK_BASE = '<your-dapp-domain>:///api/<version>';
 
const APP_INFO = {
  domain: 'https://your-dapp-domain.com',
  name: 'your-dapp-name',
};
[P] Example:
[CODE] const PETRA_LINK_BASE = 'petra://api/v1';
const DAPP_LINK_BASE = 'mobile2mobile-example:///api/v1';
 
const APP_INFO = {
  domain: 'https://mobile2mobile-example.petra.app',
  name: 'mobile2mobile-example',
};
[H3] Generate Key Pair
[P] Create a key pair using a cryptographic library like tweetnacl (opens in a new tab). This key pair consists of a secret key (private) and a public key. The secret key is essential for secure communication and should be stored securely within your dApp. The public key will be shared with Petra to establish a secure connection.
[P] Example:
[CODE] import nacl from 'tweetnacl';
 
const generateAndSaveKeyPair = () => {
  const keyPair = nacl.box.keyPair();
 
  setSecretKey(keyPair.secretKey);
  setPublicKey(keyPair.publicKey);
 
  return keyPair;
};
[H3] Connect
[CODE] To initiate a connection, create a deep link with the PETRA_LINK_BASE
[CODE] /connect
[P] Example:
[CODE] const connect = async () => {
  const keyPair = generateAndSaveKeyPair();
 
  const data = {
    appInfo: APP_INFO,
    redirectLink: `${DAPP_LINK_BASE}/connect`,
    dappEncryptionPublicKey: Buffer.from(keyPair.publicKey).toString('hex'),
  };
 
  await Linking.openURL(
    `${PETRA_LINK_BASE}/connect?data=${btoa(JSON.stringify(data))}`,
  );
};
[CODE] When the function above is called, it will open the Petra wallet with the connection request, and users will see your dApp's information. They can then approve or reject the connection request. If the user rejects the request, Petra will discard the connection and redirect back to your dApp through the provided redirect link with the response set to "rejected"
[CODE] "approved"
[H3] Handling Petra Response
[P] When Petra redirects back to your dApp through the deep link, you need to handle the URL.
[P] Example:
[CODE] useEffect(() => {
  const handleConnectionApproval = (data: string | null) => {...};
 
  const handleConnectionRejection = () => {...};
 
  const handleConnection = (params: URLSearchParams) => {...};
 
  const handleUrl = (url: string | null) => {...};
 
  Linking.getInitialURL().then(handleUrl);
 
  Linking.addEventListener('url', ({url}) => handleUrl(url));
 
  return () => {
    Linking.removeAllListeners('url');
  };
}, [secretKey]);
[CODE] The above code snippet is a React Native example that uses the Linking
[CODE] When connecting to Petra, you need to handle the response
[CODE] approved
[CODE] rejected
[CODE] data
[CODE] petraPublicEncryptedKey
[P] Example:
[CODE] const handleConnectionApproval = (data: string | null) => {
  if (data === null) {
    throw new Error('Missing data from Petra response');
  }
 
  if (!secretKey) {
    throw new Error('Missing key pair');
  }
 
  const { petraPublicEncryptedKey } = JSON.parse(atob(data));
 
  const sharedEncryptionSecretKey = nacl.box.before(
    Buffer.from(petraPublicEncryptedKey.slice(2), 'hex'),
    secretKey,
  );
  setSharedPublicKey(sharedEncryptionSecretKey);
};
 
const handleConnectionRejection = () => {
  // TODO: Handle rejection
};
 
const handleConnection = (params: URLSearchParams) => {
  if (params.get('response') === 'approved') {
    handleConnectionApproval(params.get('data'));
  } else {
    handleConnectionRejection();
  }
};
 
const handleUrl = (url: string | null) => {
  if (!url) {
    return;
  }
 
  const urlObject = new URL(url);
  const params = new URLSearchParams(urlObject.search);
 
  switch (urlObject.pathname) {
    case '/api/v1/connect': {
      handleConnection(params);
      break;
    }
    default:
      break;
  }
};
[H3] Sign and Submit Transaction
[CODE] To sign and submit a transaction through the Petra mobile wallet, create a deep link with the PETRA_LINK_BASE
[CODE] /signAndSubmit
[P] Example:
[CODE] const signAndSubmitTransaction = () => {
  if (!sharedPublicKey) {
    throw new Error('Missing shared public key');
  }
 
  if (!publicKey) {
    throw new Error('Missing public key');
  }
 
  const payload = btoa(
    JSON.stringify({
      arguments: [
        '0x0000000000000000000000000000000000000000000000000000000000000001',
        10000000, // 0.1 APT
      ],
      function: '0x1::coin::transfer',
      type: 'entry_function_payload',
      type_arguments: ['0x1::aptos_coin::AptosCoin'],
    }),
  );
 
  const nonce = nacl.randomBytes(24);
 
  const encryptedPayload = nacl.box.after(
    Buffer.from(JSON.stringify(payload)),
    nonce,
    sharedPublicKey,
  );
 
  const data = btoa(
    JSON.stringify({
      appInfo: APP_INFO,
      payload: Buffer.from(encryptedPayload).toString('hex'),
      redirectLink: `${DAPP_LINK_BASE}/response`,
      dappEncryptionPublicKey: Buffer.from(publicKey).toString('hex'),
      nonce: Buffer.from(nonce).toString('hex'),
    }),
  );
 
  Linking.openURL(`${PETRA_LINK_BASE}/signAndSubmit?data=${data}`);
};
[CODE] The above code snippet demonstrates how to sign and submit a transaction to transfer 0.1 APT to 0x0000000000000000000000000000000000000000000000000000000000000001
[CODE] coin::transfer
[P] When the function above is called, it will open the Petra wallet with the transaction request, and users will see your dApp's information, the transaction details, and the amount to be signed.
[H3] Sign Message
[CODE] To sign an arbitrary message through the Petra mobile wallet, create a deep link with the PETRA_LINK_BASE
[CODE] /signMessage
[CODE] data
[H4] Example
[CODE] const signMessage = () => {
  if (!sharedPublicKey) {
    throw new Error('Missing shared public key');
  }
 
  if (!publicKey) {
    throw new Error('Missing public key');
  }
 
  const message = 'I am signing this message with Petra Wallet!';
  const nonce = nacl.randomBytes(24);
 
  const encryptedPayload = nacl.box.after(
    Buffer.from(message),
    nonce,
    sharedPublicKey,
  );
 
  const data = btoa(
    JSON.stringify({
      appInfo: APP_INFO,
      payload: Buffer.from(encryptedPayload).toString('hex'),
      redirectLink: `${DAPP_LINK_BASE}/response`,
      dappEncryptionPublicKey: Buffer.from(publicKey).toString('hex'),
      nonce: Buffer.from(nonce).toString('hex'),
    }),
  );
 
  Linking.openURL(`${PETRA_LINK_BASE}/signMessage?data=${data}`);
};
[H3] Disconnect
[CODE] To terminate the connection, create a deep link with the PETRA_LINK_BASE
[CODE] /disconnect
[P] Example:
[CODE] const disconnect = () => {
  if (!publicKey) {
    throw new Error('Missing public key');
  }
 
  const data = {
    appInfo: APP_INFO,
    redirectLink: `${DAPP_LINK_BASE}/disconnect`,
    dappEncryptionPublicKey: Buffer.from(publicKey).toString('hex'),
  };
 
  Linking.openURL(
    `${PETRA_LINK_BASE}/disconnect?data=${btoa(JSON.stringify(data))}`,
  );
 
  setSecretKey(null);
  setPublicKey(null);
  setSharedPublicKey(null);
};
[H3] Example
[P] For a complete implementation of the deep linking functionality described in this guide, including connecting, disconnecting, and signing transactions through the Petra wallet, you can refer to the example code available on GitHub. The repository provides detailed examples using React Native:
[P] https://github.com/aptos-labs/mobile2mobile-example (opens in a new tab)